name: CVE scan on PR

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  dependency-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK and enable Maven cache
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 8
          cache: maven

      - name: Cache OWASP Dependency-Check NVD database
        uses: actions/cache@v4
        with:
          path: ~/.m2/dependency-check-cache
          key: ${{ runner.os }}-nvd-cache-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-nvd-cache-

      - name: Run OWASP Dependency-Check (fail on CVSS >= 7)
        # export the secret into the step environment; secrets are masked in logs
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
          MAVEN_OPTS: "-Xmx2g"
        run: |
          # If the workflow is triggered from a forked PR, secrets are not available.
          if [ -z "${NVD_API_KEY}" ]; then
            echo "WARNING: NVD_API_KEY is not set. The scan will run without an API key (slow or rate-limited) or may cause 403/404 from NVD."
          else
            echo "NVD_API_KEY is set (masked)."
          fi

          MAX_ATTEMPTS=3
          attempt=0
          rc=0

          until [ $attempt -ge $MAX_ATTEMPTS ]
          do
            attempt=$((attempt+1))
            echo "Running dependency-check (attempt $attempt/$MAX_ATTEMPTS)..."

            # Pass both commonly accepted property names to be tolerant (-Dnvd.apiKey is the canonical one)
            mvn -B -DskipTests verify -Dnvd.apiKey="${NVD_API_KEY}" -DnvdApiKey="${NVD_API_KEY}" && rc=0 || rc=$?

            if [ $rc -eq 0 ]; then
              echo "dependency-check succeeded"
              break
            fi

            echo "dependency-check failed with exit code $rc"

            # If it's the last attempt, break and fail; otherwise sleep with increasing backoff
            if [ $attempt -lt $MAX_ATTEMPTS ]; then
              sleep_seconds=$((attempt * 30))
              echo "Sleeping for ${sleep_seconds}s before retrying (backoff)..."
              sleep $sleep_seconds
            fi
          done

          if [ $rc -ne 0 ]; then
            echo "dependency-check failed after ${MAX_ATTEMPTS} attempts. Check NVD API key validity and rate limits."
            exit $rc
          fi

      - name: Upload Dependency-Check reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: target/dependency-check-report.*
